import React, { useState, createContext, useContext, useEffect } from 'react';
import { Menu, X, Book, Users, UserCircle, BarChart3, Bell, Settings, LogOut, Home, BookOpen, UserPlus, FileText, Clock, TrendingUp, Shield, Activity } from 'lucide-react';

// Auth Context
const AuthContext = createContext();

const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within AuthProvider');
  return context;
};

const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);

  useEffect(() => {
    // Check for stored auth token
    const token = localStorage.getItem('token');
    const storedUser = localStorage.getItem('user');
    if (token && storedUser) {
      setUser(JSON.parse(storedUser));
      setIsAuthenticated(true);
    }
  }, []);

  const login = (userData, token) => {
    localStorage.setItem('token', token);
    localStorage.setItem('user', JSON.stringify(userData));
    setUser(userData);
    setIsAuthenticated(true);
  };

  const logout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    setUser(null);
    setIsAuthenticated(false);
  };

  return (
    <AuthContext.Provider value={{ user, isAuthenticated, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};

// Login Page
const LoginPage = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [role, setRole] = useState('member');

  const handleSubmit = (e) => {
    e.preventDefault();
    // Simulate login
    const userData = { 
      id: 1, 
      name: email.split('@')[0], 
      email, 
      role: role.toUpperCase() 
    };
    onLogin(userData, 'fake-jwt-token-' + Date.now());
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-indigo-600 rounded-full mb-4">
            <Book className="w-8 h-8 text-white" />
          </div>
          <h1 className="text-3xl font-bold text-gray-800">Library System</h1>
          <p className="text-gray-600 mt-2">Sign in to your account</p>
        </div>

        <div className="space-y-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              placeholder="admin@library.com"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              placeholder="••••••••"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Role (Demo)</label>
            <select
              value={role}
              onChange={(e) => setRole(e.target.value)}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            >
              <option value="admin">Admin</option>
              <option value="librarian">Librarian</option>
              <option value="member">Member</option>
            </select>
          </div>

          <button
            onClick={handleSubmit}
            className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200"
          >
            Sign In
          </button>
        </div>

        <div className="mt-6 text-center text-sm text-gray-600">
          <a href="#" className="text-indigo-600 hover:text-indigo-700">Forgot password?</a>
        </div>
      </div>
    </div>
  );
};

// Dashboard Cards
const DashboardCard = ({ title, value, icon: Icon, color, trend }) => (
  <div className="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition duration-200">
    <div className="flex items-center justify-between">
      <div>
        <p className="text-gray-600 text-sm font-medium">{title}</p>
        <h3 className="text-3xl font-bold text-gray-800 mt-2">{value}</h3>
        {trend && (
          <p className="text-sm text-green-600 mt-2 flex items-center">
            <TrendingUp className="w-4 h-4 mr-1" />
            {trend}
          </p>
        )}
      </div>
      <div className={`${color} p-4 rounded-full`}>
        <Icon className="w-8 h-8 text-white" />
      </div>
    </div>
  </div>
);

// Admin Dashboard
const AdminDashboard = () => (
  <div className="space-y-6">
    <div className="flex items-center justify-between">
      <h1 className="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
      <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center">
        <FileText className="w-4 h-4 mr-2" />
        Generate Report
      </button>
    </div>

    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <DashboardCard title="Total Books" value="2,543" icon={Book} color="bg-blue-500" trend="+12% this month" />
      <DashboardCard title="Active Members" value="1,234" icon={Users} color="bg-green-500" trend="+8% this month" />
      <DashboardCard title="Books Borrowed" value="456" icon={BookOpen} color="bg-purple-500" trend="23 today" />
      <DashboardCard title="Overdue Books" value="28" icon={Clock} color="bg-red-500" trend="-5 from yesterday" />
    </div>

    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div className="bg-white rounded-xl shadow-md p-6">
        <h3 className="text-xl font-bold text-gray-800 mb-4">Recent Activities</h3>
        <div className="space-y-4">
          {[
            { action: 'Book issued', user: 'John Doe', book: 'The Great Gatsby', time: '5 mins ago' },
            { action: 'New member', user: 'Jane Smith', book: 'Joined library', time: '1 hour ago' },
            { action: 'Book returned', user: 'Mike Wilson', book: '1984', time: '2 hours ago' },
            { action: 'Fine paid', user: 'Sarah Brown', book: '$15.00', time: '3 hours ago' }
          ].map((activity, i) => (
            <div key={i} className="flex items-center justify-between border-b pb-3">
              <div>
                <p className="font-semibold text-gray-800">{activity.action}</p>
                <p className="text-sm text-gray-600">{activity.user} - {activity.book}</p>
              </div>
              <span className="text-xs text-gray-500">{activity.time}</span>
            </div>
          ))}
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-md p-6">
        <h3 className="text-xl font-bold text-gray-800 mb-4">Top Borrowed Books</h3>
        <div className="space-y-3">
          {[
            { title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', count: 45 },
            { title: '1984', author: 'George Orwell', count: 38 },
            { title: 'To Kill a Mockingbird', author: 'Harper Lee', count: 35 },
            { title: 'Pride and Prejudice', author: 'Jane Austen', count: 32 },
            { title: 'The Catcher in the Rye', author: 'J.D. Salinger', count: 28 }
          ].map((book, i) => (
            <div key={i} className="flex items-center justify-between">
              <div className="flex-1">
                <p className="font-semibold text-gray-800">{book.title}</p>
                <p className="text-sm text-gray-600">{book.author}</p>
              </div>
              <span className="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold">
                {book.count} borrows
              </span>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
);

// Books List Page
const BooksListPage = () => {
  const [searchTerm, setSearchTerm] = useState('');

  const books = [
    { id: 1, title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', isbn: '978-0-7432-7356-5', category: 'Fiction', status: 'Available', copies: 5 },
    { id: 2, title: '1984', author: 'George Orwell', isbn: '978-0-452-28423-4', category: 'Fiction', status: 'Borrowed', copies: 3 },
    { id: 3, title: 'To Kill a Mockingbird', author: 'Harper Lee', isbn: '978-0-06-112008-4', category: 'Fiction', status: 'Available', copies: 4 },
    { id: 4, title: 'Pride and Prejudice', author: 'Jane Austen', isbn: '978-0-14-143951-8', category: 'Romance', status: 'Available', copies: 6 },
    { id: 5, title: 'The Catcher in the Rye', author: 'J.D. Salinger', isbn: '978-0-316-76948-0', category: 'Fiction', status: 'Borrowed', copies: 2 }
  ];

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold text-gray-800">Books Management</h1>
        <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center">
          <BookOpen className="w-4 h-4 mr-2" />
          Add New Book
        </button>
      </div>

      <div className="bg-white rounded-xl shadow-md p-6">
        <div className="flex gap-4 mb-6">
          <input
            type="text"
            placeholder="Search books by title, author, or ISBN..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />
          <button className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Filter
          </button>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b">
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Title</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Author</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">ISBN</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Category</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Copies</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
              </tr>
            </thead>
            <tbody>
              {books.map((book) => (
                <tr key={book.id} className="border-b hover:bg-gray-50">
                  <td className="py-3 px-4 font-medium text-gray-800">{book.title}</td>
                  <td className="py-3 px-4 text-gray-600">{book.author}</td>
                  <td className="py-3 px-4 text-gray-600">{book.isbn}</td>
                  <td className="py-3 px-4">
                    <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">
                      {book.category}
                    </span>
                  </td>
                  <td className="py-3 px-4">
                    <span className={`px-2 py-1 rounded text-sm ${
                      book.status === 'Available' 
                        ? 'bg-green-100 text-green-800' 
                        : 'bg-yellow-100 text-yellow-800'
                    }`}>
                      {book.status}
                    </span>
                  </td>
                  <td className="py-3 px-4 text-gray-600">{book.copies}</td>
                  <td className="py-3 px-4">
                    <button className="text-indigo-600 hover:text-indigo-800 mr-3">Edit</button>
                    <button className="text-red-600 hover:text-red-800">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

// Members List Page
const MembersListPage = () => {
  const members = [
    { id: 1, name: 'John Doe', email: 'john@example.com', phone: '+1-234-567-8901', status: 'Active', borrowed: 3, joined: '2024-01-15' },
    { id: 2, name: 'Jane Smith', email: 'jane@example.com', phone: '+1-234-567-8902', status: 'Active', borrowed: 1, joined: '2024-02-20' },
    { id: 3, name: 'Mike Wilson', email: 'mike@example.com', phone: '+1-234-567-8903', status: 'Active', borrowed: 2, joined: '2024-03-10' },
    { id: 4, name: 'Sarah Brown', email: 'sarah@example.com', phone: '+1-234-567-8904', status: 'Inactive', borrowed: 0, joined: '2023-12-05' }
  ];

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold text-gray-800">Members Management</h1>
        <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center">
          <UserPlus className="w-4 h-4 mr-2" />
          Add New Member
        </button>
      </div>

      <div className="bg-white rounded-xl shadow-md p-6">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b">
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Name</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Email</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Phone</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Books Borrowed</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Member Since</th>
                <th className="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
              </tr>
            </thead>
            <tbody>
              {members.map((member) => (
                <tr key={member.id} className="border-b hover:bg-gray-50">
                  <td className="py-3 px-4 font-medium text-gray-800">{member.name}</td>
                  <td className="py-3 px-4 text-gray-600">{member.email}</td>
                  <td className="py-3 px-4 text-gray-600">{member.phone}</td>
                  <td className="py-3 px-4">
                    <span className={`px-2 py-1 rounded text-sm ${
                      member.status === 'Active' 
                        ? 'bg-green-100 text-green-800' 
                        : 'bg-gray-100 text-gray-800'
                    }`}>
                      {member.status}
                    </span>
                  </td>
                  <td className="py-3 px-4 text-gray-600">{member.borrowed}</td>
                  <td className="py-3 px-4 text-gray-600">{member.joined}</td>
                  <td className="py-3 px-4">
                    <button className="text-indigo-600 hover:text-indigo-800 mr-3">View</button>
                    <button className="text-blue-600 hover:text-blue-800">Edit</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

// Sidebar Navigation
const Sidebar = ({ currentPage, setCurrentPage, userRole, onLogout }) => {
  const [isMobileOpen, setIsMobileOpen] = useState(false);

  const menuItems = {
    ADMIN: [
      { id: 'dashboard', label: 'Dashboard', icon: Home },
      { id: 'books', label: 'Books', icon: Book },
      { id: 'members', label: 'Members', icon: Users },
      { id: 'users', label: 'Users & Roles', icon: Shield },
      { id: 'borrow', label: 'Borrowing', icon: BookOpen },
      { id: 'reports', label: 'Reports', icon: BarChart3 },
      { id: 'audit', label: 'Audit Logs', icon: Activity },
      { id: 'notifications', label: 'Notifications', icon: Bell },
      { id: 'settings', label: 'Settings', icon: Settings }
    ],
    LIBRARIAN: [
      { id: 'dashboard', label: 'Dashboard', icon: Home },
      { id: 'books', label: 'Books', icon: Book },
      { id: 'members', label: 'Members', icon: Users },
      { id: 'borrow', label: 'Borrowing', icon: BookOpen },
      { id: 'reports', label: 'Reports', icon: BarChart3 },
      { id: 'notifications', label: 'Notifications', icon: Bell }
    ],
    MEMBER: [
      { id: 'dashboard', label: 'My Dashboard', icon: Home },
      { id: 'books', label: 'Browse Books', icon: Book },
      { id: 'my-borrows', label: 'My Borrows', icon: BookOpen },
      { id: 'notifications', label: 'Notifications', icon: Bell },
      { id: 'profile', label: 'Profile', icon: UserCircle }
    ]
  };

  const items = menuItems[userRole] || menuItems.MEMBER;

  return (
    <>
      {/* Mobile Menu Button */}
      <button
        onClick={() => setIsMobileOpen(!isMobileOpen)}
        className="lg:hidden fixed top-4 left-4 z-50 p-2 bg-indigo-600 text-white rounded-lg"
      >
        {isMobileOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
      </button>

      {/* Sidebar */}
      <div className={`fixed lg:static inset-y-0 left-0 z-40 w-64 bg-gray-900 text-white transform transition-transform duration-300 ${
        isMobileOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'
      }`}>
        <div className="p-6 border-b border-gray-800">
          <div className="flex items-center space-x-3">
            <Book className="w-8 h-8" />
            <div>
              <h2 className="text-xl font-bold">Library System</h2>
              <p className="text-xs text-gray-400">{userRole}</p>
            </div>
          </div>
        </div>

        <nav className="p-4 space-y-2">
          {items.map((item) => {
            const Icon = item.icon;
            return (
              <button
                key={item.id}
                onClick={() => {
                  setCurrentPage(item.id);
                  setIsMobileOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition duration-200 ${
                  currentPage === item.id
                    ? 'bg-indigo-600 text-white'
                    : 'text-gray-300 hover:bg-gray-800'
                }`}
              >
                <Icon className="w-5 h-5" />
                <span>{item.label}</span>
              </button>
            );
          })}
        </nav>

        <div className="absolute bottom-0 w-full p-4 border-t border-gray-800">
          <button
            onClick={onLogout}
            className="w-full flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-gray-800 rounded-lg transition duration-200"
          >
            <LogOut className="w-5 h-5" />
            <span>Logout</span>
          </button>
        </div>
      </div>

      {/* Mobile Overlay */}
      {isMobileOpen && (
        <div
          onClick={() => setIsMobileOpen(false)}
          className="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-30"
        />
      )}
    </>
  );
};

// Main App Component
const App = () => {
  const [currentPage, setCurrentPage] = useState('dashboard');

  const renderPage = (page, role) => {
    switch (page) {
      case 'dashboard':
        return <AdminDashboard />;
      case 'books':
        return <BooksListPage />;
      case 'members':
        return <MembersListPage />;
      default:
        return (
          <div className="bg-white rounded-xl shadow-md p-8 text-center">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">
              {page.charAt(0).toUpperCase() + page.slice(1)} Page
            </h2>
            <p className="text-gray-600">This page is under construction.</p>
          </div>
        );
    }
  };

  return (
    <AuthProvider>
      <AuthContext.Consumer>
        {({ user, isAuthenticated, login, logout }) => {
          if (!isAuthenticated) {
            return <LoginPage onLogin={login} />;
          }

          return (
            <div className="flex h-screen bg-gray-100">
              <Sidebar
                currentPage={currentPage}
                setCurrentPage={setCurrentPage}
                userRole={user.role}
                onLogout={logout}
              />

              <main className="flex-1 overflow-y-auto p-8">
                <div className="max-w-7xl mx-auto">
                  {renderPage(currentPage, user.role)}
                </div>
              </main>
            </div>
          );
        }}
      </AuthContext.Consumer>
    </AuthProvider>
  );
};

export default App;